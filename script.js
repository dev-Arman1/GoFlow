let map=L.map('map').setView([28.6139,77.2090],6);L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png',{attribution:'© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors © <a href="https://carto.com/attributions">CARTO</a>',subdomains:'abcd',maxZoom:19}).addTo(map);let startMarker,endMarker,routeLayer;let startCoords,endCoords;const startIcon=L.icon({iconUrl:'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',shadowUrl:'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowSize:[41,41]});const endIcon=L.icon({iconUrl:'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',shadowUrl:'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowSize:[41,41]});function showToast(message,type='info'){const existingToast=document.querySelector('.toast');if(existingToast){existingToast.remove()}const toast=document.createElement('div');toast.className=`toast toast-${type}`;let icon='';switch(type){case'success':icon='<i class="fas fa-check-circle"></i>';break;case'error':icon='<i class="fas fa-exclamation-circle"></i>';break;default:icon='<i class="fas fa-info-circle"></i>'}toast.innerHTML=`${icon}<div class="toast-content">${message}</div>`;document.body.appendChild(toast);setTimeout(()=>{toast.classList.add('show')},10);setTimeout(()=>{toast.classList.remove('show');setTimeout(()=>{toast.remove()},300)},3000)}function addToRecentSearches(start,end){if(!start||!end)return;const searchesList=document.getElementById('searchesList');const listItem=document.createElement('li');listItem.innerHTML=`<strong>${start}</strong> to <strong>${end}</strong>`;listItem.addEventListener('click',()=>{document.getElementById('searchStartInput').value=start;document.getElementById('searchEndInput').value=end;searchStartLocation();setTimeout(()=>{searchEndLocation()},1000)});if(searchesList.childElementCount>=5){searchesList.removeChild(searchesList.lastChild)}searchesList.insertBefore(listItem,searchesList.firstChild)}function searchStartLocation(){const query=document.getElementById('searchStartInput').value;if(query){showToast(`Searching for "${query}"...`,'info');fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${query}`).then(response=>{if(!response.ok){throw new Error('Network response was not ok')}return response.json()}).then(data=>{if(data.length>0){const firstResult=data[0];const lat=parseFloat(firstResult.lat);const lon=parseFloat(firstResult.lon);startCoords={lat,lng:lon};if(startMarker)map.removeLayer(startMarker);startMarker=L.marker([lat,lon],{icon:startIcon}).addTo(map).bindPopup(`<b>Start:</b> ${firstResult.display_name.split(',').slice(0,2).join(',')}`).openPopup();map.flyTo([lat,lon],13,{duration:1.5,easeLinearity:0.25});showToast('Start location set!','success')}else{showToast('Start location not found. Try a different search.','error')}}).catch(err=>{console.error("Error searching start location:",err);showToast('Error searching location. Please try again.','error')})}else{showToast('Please enter a start location to search.','error')}}function searchEndLocation(){const query=document.getElementById('searchEndInput').value;if(query){showToast(`Searching for "${query}"...`,'info');fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${query}`).then(response=>{if(!response.ok){throw new Error('Network response was not ok')}return response.json()}).then(data=>{if(data.length>0){const firstResult=data[0];const lat=parseFloat(firstResult.lat);const lon=parseFloat(firstResult.lon);endCoords={lat,lng:lon};if(endMarker)map.removeLayer(endMarker);endMarker=L.marker([lat,lon],{icon:endIcon}).addTo(map).bindPopup(`<b>Destination:</b> ${firstResult.display_name.split(',').slice(0,2).join(',')}`).openPopup();map.flyTo([lat,lon],13,{duration:1.5,easeLinearity:0.25});showToast('Destination set!','success');if(document.getElementById('searchStartInput').value){addToRecentSearches(document.getElementById('searchStartInput').value,query)}}else{showToast('Destination not found. Try a different search.','error')}}).catch(err=>{console.error("Error searching destination location:",err);showToast('Error searching location. Please try again.','error')})}else{showToast('Please enter a destination location to search.','error')}}function setStart(){showToast('Click on the map to set start point','info');document.body.style.cursor='crosshair';map.once('click',function(e){if(startMarker)map.removeLayer(startMarker);startCoords=e.latlng;startMarker=L.marker(startCoords,{icon:startIcon}).addTo(map).bindPopup("<b>Start</b>").openPopup();document.body.style.cursor='';showToast('Start point set!','success')})}function setEnd(){showToast('Click on the map to set destination point','info');document.body.style.cursor='crosshair';map.once('click',function(e){if(endMarker)map.removeLayer(endMarker);endCoords=e.latlng;endMarker=L.marker(endCoords,{icon:endIcon}).addTo(map).bindPopup("<b>Destination</b>").openPopup();document.body.style.cursor='';showToast('Destination point set!','success')})}function findRoute(){if(!startCoords||!endCoords){showToast('Please select both start and destination points.','error');return}showToast('Calculating your route...','info');if(routeLayer)map.removeLayer(routeLayer);let apiUrl=`https://router.project-osrm.org/route/v1/driving/${startCoords.lng},${startCoords.lat};${endCoords.lng},${endCoords.lat}?overview=full&geometries=geojson`;fetch(apiUrl).then(response=>{if(!response.ok){throw new Error('Network response was not ok')}return response.json()}).then(data=>{if(data.routes&&data.routes.length>0){let route=data.routes[0];let distanceKm=(route.distance/1000).toFixed(2);animateValue('distance',distanceKm);let speed=parseFloat(document.getElementById('speedInput').value)||60;let timeHours=(distanceKm/speed);let hours=Math.floor(timeHours);let minutes=Math.round((timeHours-hours)*60);let timeString=hours>0?`${hours}h ${minutes}m`:`${minutes}m`;animateValue('time',timeString);let mileage=parseFloat(document.getElementById('mileageInput').value)||15;let fuelPrice=parseFloat(document.getElementById('fuelPriceInput').value)||100;let fuelCost=((distanceKm/mileage)*fuelPrice).toFixed(2);animateValue('fuelCost',fuelCost);let tollCostPerKm=parseFloat(document.getElementById('tollCostInput').value)||1;let totalTollCost=(distanceKm*tollCostPerKm).toFixed(2);animateValue('totalTollCost',totalTollCost);let totalCost=(parseFloat(fuelCost)+parseFloat(totalTollCost)).toFixed(2);animateValue('totalCost',totalCost);routeLayer=L.geoJSON(route.geometry,{style:{color:'#3b82f6',weight:6,opacity:0.8,lineCap:'round',lineJoin:'round',dashArray:'1, 10',dashOffset:'0'}}).addTo(map);const routePath=document.querySelector('.leaflet-interactive');if(routePath){routePath.style.strokeDasharray=route.distance/30;routePath.style.strokeDashoffset=route.distance/30;routePath.style.animation='drawRoute 1.5s forwards'}document.getElementById('routeInfo').style.display='block';map.fitBounds(routeLayer.getBounds(),{padding:[50,50],animate:true,duration:1});showToast('Route calculated successfully!','success')}else{showToast('Could not find a route between these points.','error')}}).catch(err=>{console.error("Error fetching route:",err);showToast('Error calculating route. Please try again.','error')})}function animateValue(elementId,newValue){const element=document.getElementById(elementId);element.classList.add('value-change');element.textContent=newValue;setTimeout(()=>{element.classList.remove('value-change')},500)}document.addEventListener('DOMContentLoaded',function(){document.getElementById('menuToggle').addEventListener('click',function(){document.getElementById('sidebar').classList.add('open')});document.getElementById('closeSidebar').addEventListener('click',function(){document.getElementById('sidebar').classList.remove('open')});document.getElementById('minimizeRouteInfo').addEventListener('click',function(){document.getElementById('routeInfo').classList.toggle('minimized');const icon=this.querySelector('i');if(icon.classList.contains('fa-chevron-down')){icon.classList.remove('fa-chevron-down');icon.classList.add('fa-chevron-up')}else{icon.classList.remove('fa-chevron-up');icon.classList.add('fa-chevron-down')}});document.getElementById('vehicleSettingsHeader').addEventListener('click',function(){this.classList.toggle('active');const content=document.getElementById('vehicleSettings');content.classList.toggle('open')});document.getElementById('searchStartInput').addEventListener('keypress',function(e){if(e.key==='Enter'){searchStartLocation()}});document.getElementById('searchEndInput').addEventListener('keypress',function(e){if(e.key==='Enter'){searchEndLocation()}});document.getElementById('shareRoute').addEventListener('click',function(){if(!startCoords||!endCoords){showToast('No route to share yet!','error');return}const shareText=`Check out this route I found on GoFlow Maps! From ${document.getElementById('searchStartInput').value} to ${document.getElementById('searchEndInput').value}`;if(navigator.share){navigator.share({title:'GoFlow Maps Route',text:shareText}).then(()=>showToast('Route shared successfully!','success')).catch(err=>showToast('Could not share the route','error'))}else{navigator.clipboard.writeText(shareText).then(()=>showToast('Route info copied to clipboard!','success')).catch(()=>showToast('Could not copy to clipboard','error'))}});document.getElementById('saveRoute').addEventListener('click',function(){if(!startCoords||!endCoords){showToast('No route to save yet!','error');return}const routeData={start:document.getElementById('searchStartInput').value,end:document.getElementById('searchEndInput').value,distance:document.getElementById('distance').textContent,time:document.getElementById('time').textContent,totalCost:document.getElementById('totalCost').textContent};let savedRoutes=JSON.parse(localStorage.getItem('savedRoutes'))||[];savedRoutes.push(routeData);localStorage.setItem('savedRoutes',JSON.stringify(savedRoutes));showToast('Route saved successfully!','success')});document.getElementById('routeInfo').style.display='none';setTimeout(()=>{showToast('Welcome to GoFlow Maps! Get started by setting your route points.','info')},1000)});
